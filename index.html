<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>éŸ³å£°äºˆå®šç™»éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ff9500">

  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="app">
  <header>ğŸ“… éŸ³å£°äºˆå®šç™»éŒ²</header>

  <main>
    <section class="calendar">
      <div class="calendar-header" id="month"></div>
      <div class="calendar-grid" id="calendar"></div>
    </section>

    <p class="hint">ã€Œ3æœˆ5æ—¥ 14æ™‚ ä¼šè­°ã€ã®ã‚ˆã†ã«è©±ã—ã¦ãã ã•ã„</p>
    <button id="startBtn">ï¼‹ éŸ³å£°ã§äºˆå®šã‚’è¿½åŠ </button>

    <ul id="scheduleList"></ul>
  </main>
</div>

<script>
const startBtn = document.getElementById("startBtn");
const list = document.getElementById("scheduleList");
const calendarEl = document.getElementById("calendar");

const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

let recognition;
let selectedDate = formatDate(new Date());
let schedules = JSON.parse(localStorage.getItem("schedules") || "[]");

// ========================
// éŸ³å£°èªè­˜
// ========================
if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.lang = "ja-JP";
  recognition.interimResults = false;

  recognition.onresult = (e) => {
    const text = e.results[0][0].transcript;
    const parsed = parseSpeech(text);

    schedules.push(parsed);
    save();
    renderList();
    scheduleAlarm(parsed);
  };
}

startBtn.onmousedown = () => recognition?.start();
startBtn.ontouchstart = () => recognition?.start();

// ========================
// éŸ³å£°è§£æï¼ˆâ—‹æœˆâ—‹æ—¥ï¼‹æ™‚é–“ï¼‰
// ========================
function parseSpeech(text) {
  const now = new Date();
  let month = now.getMonth() + 1;
  let day = now.getDate();
  let hour = null;
  let minute = 0;

  const md = text.match(/(\d+)æœˆ(\d+)æ—¥/);
  if (md) {
    month = Number(md[1]);
    day = Number(md[2]);
  }

  const time = text.match(/(\d+)æ™‚(\d+)?åˆ†?/);
  if (time) {
    hour = Number(time[1]);
    minute = Number(time[2] || 0);
  }

  return {
    text,
    date: `${now.getFullYear()}-${pad(month)}-${pad(day)}`,
    hour,
    minute
  };
}

// ========================
// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
// ========================
function createCalendar() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  document.getElementById("month").textContent =
    `${year}å¹´ ${month + 1}æœˆ`;

  calendarEl.innerHTML = "";
  ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(d => {
    const div = document.createElement("div");
    div.className = "day-label";
    div.textContent = d;
    calendarEl.appendChild(div);
  });

  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();

  for (let i = 0; i < firstDay; i++) {
    calendarEl.appendChild(document.createElement("div"));
  }

  for (let d = 1; d <= lastDate; d++) {
    const dateStr = `${year}-${pad(month + 1)}-${pad(d)}`;
    const div = document.createElement("div");
    div.className = "day";
    if (dateStr === formatDate(new Date())) div.classList.add("today");
    if (dateStr === selectedDate) div.classList.add("selected");

    div.textContent = d;
    div.onclick = () => {
      selectedDate = dateStr;
      renderList();
      createCalendar();
    };
    calendarEl.appendChild(div);
  }
}

// ========================
// äºˆå®šè¡¨ç¤º
// ========================
function renderList() {
  list.innerHTML = "";
  schedules
    .filter(s => s.date === selectedDate)
    .forEach(s => {
      const li = document.createElement("li");
      li.textContent = s.text;
      list.appendChild(li);
    });
}

// ========================
// é€šçŸ¥ï¼ˆã‚¢ãƒ©ãƒ¼ãƒ ï¼‰
// ========================
function scheduleAlarm(item) {
  if (item.hour === null) return;

  Notification.requestPermission();

  const target = new Date(
    item.date + ` ${pad(item.hour)}:${pad(item.minute)}`
  );
  const delay = target.getTime() - Date.now();
  if (delay <= 0) return;

  setTimeout(() => {
    new Notification("äºˆå®šã®æ™‚é–“ã§ã™", {
      body: item.text
    });
  }, delay);
}

// ========================
function save() {
  localStorage.setItem("schedules", JSON.stringify(schedules));
}

function pad(n) {
  return String(n).padStart(2, "0");
}

function formatDate(d) {
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

// åˆæœŸåŒ–
createCalendar();
renderList();
</script>
</body>
</html>
